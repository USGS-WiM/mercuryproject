{% extends 'mercurylab/base.html' %}
{% block body_block %}

    <div class="jumbotron">
        <p>
            <!-- <button type="button" class="btn btn-default" name="save">Save</button> -->
        </p>
        <pre id="grid_console" class="console" style="width:600px"></pre>
        <div id="form_result_search">
            {% csrf_token %}
            <p>
                <input id="select_bottle" type="hidden" placeholder="Bottle Code" style="width:297px"/>
                <input id="select_project" type="hidden" placeholder="Project Name" style="width:600px"/>
                <input id="select_site" type="hidden" placeholder="Site Name" style="width:600px"/>
            </p>
            <p>
                <input id="select_constituent" type="hidden" placeholder="Constituent" style="width:297px"/>
                <!-- <input id="select_depth" type="number" placeholder="Depth" style="width:297px"/> -->
                <!-- <input id="select_replicate" type="number" placeholder="Replicate" style="width:297px"/> -->
                <input id="date_after" placeholder="After Date" style="width:297px"/>
                <input id="date_before" placeholder="Before Date" style="width:297px"/>
            </p>
            <p>
                <button type="button" class="btn btn-default" name="search">Search</button>
            </p>
        </div>

        <p>
            <div class="select2-container select2-container-multi" style="width:600px">
                <ul class="select2-choices">
                    <li class="select2-search-field">
                        <label class="select2-offscreen"></label>
                        <input id="search_field" type="search" placeholder="Highlight in table." class="select2-input select2-default" style="width:593px;height:40px;font-size:21px;"/>
                    </li>
                </ul>
            </div>
        <!-- <p><input id="search_field" type="search" placeholder="Highlight in table." style="width:600px; border:1px solid darkgray; height:42px"/></p> -->
        <br /><br />
        <div id="grid" data-projects="{{ projects }}" data-constituents="{{ constituents }}" class="table table-hover table-condensed table-bordered"></div>

        <script>
            $(document).ready(function() {

                var csrftoken = $.cookie('csrftoken');
                function csrfSafeMethod(method) {
                    // these HTTP methods do not require CSRF protection
                    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                }
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });

                var grid = $('#grid');
                var grid_console = $("#grid_console");
                var data_data = {};
                grid.css("z-index", "0");
                var data_projects = JSON.parse(grid.attr('data-projects'));
                var data_sites;
                var data_constituents = JSON.parse(grid.attr('data-constituents'));
                grid_console.text('Loading data...');
                grid.handsontable({
                    data: data_data,
                    columns: [
                        {title: 'ID', data: 'id', readOnly: true, width: 1},
                        {title: 'Bottle', data: 'sample_bottle.bottle.bottle_unique_name', readOnly: true, width: 100},
                        {title: 'Tare Weight', data: 'sample_bottle.bottle.tare_weight', readOnly: true, width: 100},
                        {title: 'Project', data: 'sample_bottle.sample.project.name', readOnly: true, width: 200},
                        {title: 'Site', data: 'sample_bottle.sample.site.name', readOnly: true, width: 200},
                        {title: 'Date', data: 'sample_bottle.sample.date', readOnly: true, width: 100},
                        {title: 'Time', data: 'sample_bottle.sample.time', readOnly: true, width: 60},
                        {title: 'Constituent', data: 'constituent', readOnly: true, width: 100},
                        {title: 'Received', data: 'sample_bottle.sample.received_time_stamp', readOnly: true, width: 100},
                        {title: 'Comments', data: 'sample_bottle.sample.comment', readOnly: true, width: 200},
                        {title: 'Result', data: 'final_value', readOnly: true, width: 100},
                        {title: 'Analyzed', data: 'analyzed_date', readOnly: true, width: 140}
                    ],
                    search: true
                });
                grid_console.text('Data loaded.');

                $('#search_field').on('keyup', function (event) {
                    grid.handsontable('getInstance').search.query(this.value);
                    grid.handsontable('getInstance').render();
                });

                var select_bottle = $("#select_bottle").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    ajax: {
                        url: '/mercuryservices/bottles/',
                        dataType: 'json',
                        data: function (term, page) {
                            return {
                                name: term
                            };
                        },
                        results: function (data, page) {
                            //data_data = data;
                            //grid.data('handsontable').loadData(data.results);
                            grid_console.text('Filtered data loaded.');
                            return {results: data.results};
                        }
                    },
                    formatResult: formatBottle,
                    formatSelection: formatBottle
                });

                var select_project = $("#select_project").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    data: { results: data_projects, text: 'name'},
                    formatResult: formatName,
                    formatSelection: formatName
                });//.on("change", function(e) {});

                var select_site = $("#select_site").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    ajax: {
                        url: '/mercuryservices/sites/',
                        dataType: 'json',
                        data: function (term, page) {
                            return {
                                name: term
                            };
                        },
                        results: function (data, page) {
                            grid_console.text('Filtered data loaded.');
                            return {results: data.results};
                        }
                    },
                    formatResult: formatName,
                    formatSelection: formatName
                });

                var select_constituent = $("#select_constituent").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    data: { results: data_constituents, text: 'constituent'},
                    formatResult: formatConstituent,
                    formatSelection: formatConstituent
                });

                function formatName(data) {
                    return data.name;
                    /*var newData = [];
                    $.each(data, function(item){
                       newData.push({
                           id: item.id,
                           text: item.name
                       })
                    });
                    return newData;*/
                }

                function formatID(data) {
                    return data.id;
                }

                function formatBottle(data) {
                    return data.bottle_unique_name;
                }

                function formatConstituent(data) {
                    return data.constituent;
                }

                var date_after = $("#date_after").datepicker({
                    dateFormat: "yy-mm-dd",
                    maxDate: 0
                });

                var date_before = $("#date_before").datepicker({
                    dateFormat: "yy-mm-dd",
                    maxDate: 0
                });

                grid.parent().find('button[name=search]').click(function () {
                    grid_console.text('Attempting to search...');
                    var thisDataObject = {};
                    thisDataObject['bottle'] = $(select_bottle).val();
                    thisDataObject['project'] = $(select_project).val();
                    thisDataObject['site'] = $(select_site).val();//.slice(0, -1);
                    thisDataObject['date_after'] = $(date_after).val();
                    thisDataObject['date_before'] = $(date_before).val();
                    thisDataObject['constituent'] = $(select_constituent).val();
                    var dataJSON = JSON.stringify(thisDataObject);
                    $.ajax({
                        url: '/mercurylab/result_search/search',
                        data: dataJSON,
                        dataType: 'json',
                        contentType: "application/json",
                        type: 'POST',
                        success: function (data, textStatus, jqXHRequest) {
                            var content_type = jqXHRequest.getResponseHeader("content-type");
                            // if the content-type is plain text, then it's a custom message from our Django view
                            if (content_type.indexOf('text') > -1) {
                                grid_console.text(data);
                            }
                            // otherwise, it's JSON from the REST Services
                            else if (jqXHRequest.status === 200) {
                                data_data = data;
                                grid_console.text(textStatus+': Retrieved '+ data_data['count'] +' results.');
                                grid.data('handsontable').loadData(data_data.results);
                            }
                            else {
                                grid_console.text(textStatus+': Save error: '+jqXHRequest.statusText+', code: '+jqXHRequest.status+'.');
                            }
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + " ... " + textStatus);
                        }
                    });
                });



            });
        </script>

    </div>

{% endblock %}