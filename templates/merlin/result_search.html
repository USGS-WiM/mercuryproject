{% extends 'merlin/base.html' %}
{% block body_block %}

    <div style="padding:10px">
{#        <p>#}
{#            <!-- <button type="button" class="btn btn-default" name="save">Save</button> -->#}
{#        </p>#}
        <pre id="grid_console" class="console" style="width:600px"></pre>
        <div class="panel-default">
            <form id="form_result_search" class="form-inline">
                {% csrf_token %}
                <p>
                    <div class="form-group">
                        <label for="select_bottle">Bottle Code</label><br />
                        <input id="select_bottle" type="hidden" style="width:1200px"/>
                    </div>
                </p>
                <span>OR</span>
                <p>
                    <div class="form-group">
                        <label for="select_project">Project Name</label><br />
                        <input id="select_project" type="hidden" style="width:598px"/>
                    </div>
                    <div class="form-group">
                        <label for="select_site">Site Name</label><br />
                        <input id="select_site" type="hidden" style="width:598px"/>
                    </div>
                </p>
                <p>
                    <div class="form-group">
                        <label for="date_after_sample">After Sample Date</label><br />
                        <input id="date_after_sample" class="select2-container select2-container-multi" style="width:297px;height:34px;font-size:15px;padding-left:4px;"/>
                    </div>
                    <div class="form-group">
                        <label for="date_before_sample">Before Sample Date</label><br />
                        <input id="date_before_sample" class="select2-container select2-container-multi" style="width:297px;height:34px;font-size:15px;padding-left:4px;"/>
                    </div>
                    <div class="form-group">
                        <label for="date_after_entry">After Entry Date</label><br />
                        <input id="date_after_entry" class="select2-container select2-container-multi" style="width:297px;height:34px;font-size:15px;padding-left:4px;"/>
                    </div>
                    <div class="form-group">
                        <label for="date_before_entry">Before Entry Date</label><br />
                        <input id="date_before_entry" class="select2-container select2-container-multi" style="width:297px;height:34px;font-size:15px;padding-left:4px;"/>
                    </div>
                    <div class="form-group">
                        <label for="select_constituent">Constituent</label><br />
                        <input id="select_constituent" type="hidden" style="width:297px"/>
                    </div>
                </p>
                <p>
                    <div class="form-group">
                        <input type="checkbox" name="excludeNullResults" id="excludeNullResults" checked />
                        <label for="excludeNullResults">Exclude Null Results</label>
                    </div>
                </p>
                <p>
                    <div class="form-group">
                        <button type="button" class="btn btn-info" name="search">Search</button>
                        <button type="button" class="btn btn-default" name="exportCSV">Export CSV</button>
                        <button type="button" class="btn btn-default" name="prev">Previous Page</button>
                        <button type="button" class="btn btn-default" name="next">Next Page</button>
                        <label>Value Type:</label>
                        <div id="valueTypeRadio" class="form-group">
                            <input type="radio" name="valueType" id="valueTypeFinal" value="final"/>Final<br />
                            <input type="radio" name="valueType" id="valueTypeReport" value="report" checked />Report
                        </div>
                    </div>
                </p>
                <div id="exportCSVButtonPanel" style="display:none" >
                    <button type="button" class="btn btn-info" name="exportCSVCurrentPage">Current Page</button>
                    <button type="button" class="btn btn-info" name="exportCSVAllPages">All Pages</button>
                </div>
            </form>
        </div>

        <p>
            <div class="select2-container select2-container-multi" style="width:600px">
                <ul class="select2-choices">
                    <li class="select2-search-field">
                        <label class="select2-offscreen"></label>
                        <input id="search_field" type="search" placeholder="Highlight in table." class="select2-input select2-default" style="width:593px;height:40px;font-size:21px;"/>
                    </li>
                </ul>
            </div>
        <!-- <p><input id="search_field" type="search" placeholder="Highlight in table." style="width:600px; border:1px solid darkgray; height:42px"/></p> -->
        <br /><br />
        <div id="grid" data-projects="{{ projects }}" data-constituents="{{ constituents }}" ></div>
        <div id="tempgrid" style="display:none"></div>

        <script>
            $(document).ready(function() {

                var csrftoken = $.cookie('csrftoken');
                function csrfSafeMethod(method) {
                    // these HTTP methods do not require CSRF protection
                    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                }
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });

                var currentPage = 1;
                var resultPages = 1;
                var exportCSVClicked = false;
                var grid = $('#grid');
                var grid_console = $("#grid_console");
                var data_data;
                grid.css("z-index", "0");
                var data_projects = JSON.parse(grid.attr('data-projects'));
                var data_sites;
                var data_constituents = JSON.parse(grid.attr('data-constituents'));
                var dateToday = new Date(); //toISOString().split("T")[0];
                var yearToday = dateToday.getFullYear().toString();
                var monthToday = (dateToday.getMonth() + 1).toString();
                var dayToday = dateToday.getDate().toString();
                var grid_columns = [
                        {title: 'Result ID', data: 'id', readOnly: true, width: 100},
                        {title: 'Bottle', data: 'sample_bottle.bottle.bottle_unique_name', readOnly: true, width: 100},
                        {title: 'Tare Weight', data: 'sample_bottle.bottle.bottle_prefix.tare_weight', readOnly: true, width: 100, format: '0.0000'},
                        {title: 'Project', data: 'sample_bottle.sample.project.name', readOnly: true, width: 200},
                        {title: 'Site', data: 'sample_bottle.sample.site.name', readOnly: true, width: 200},
                        {title: 'Sample Date', data: 'sample_bottle.sample.sample_date', readOnly: true, width: 100},
                        {title: 'Sample Time', data: 'sample_bottle.sample.sample_time', readOnly: true, width: 100},
                        {title: 'Depth', data:'sample_bottle.sample.depth', readOnly: true, width: 60, format: '0.00'},
                        {title: 'Constituent', data: 'constituent', readOnly: true, width: 100},
                        {title: 'Isotope', data: 'isotope_flag', readOnly: true, width: 60},
                        {title: 'Received Date', data: 'sample_bottle.sample.received_date', readOnly: true, width: 100},
                        {title: 'Comments', data: 'sample_bottle.sample.comment', readOnly: true, width: 200},
                        {title: 'Result Value', data: 'final_value', readOnly: true, width: 100, format: '0.00000000'},
                        {title: 'Unit', data: 'method.final_value_unit', readOnly: true, width: 60},
                        {title: 'Detection Flag', data: 'detection_flag', readOnly: true, width: 100},
                        {title: 'Analyzed Date', data: 'analyzed_date', readOnly: true, width: 100}
                    ];
                var grid_options = {
                    startRows: 0,
                    data: data_data,
                    manualColumnResize: true,
                    manualRowResize: true,
                    search: {searchResultClass: 'customHtSearchResult'},
                    columns: grid_columns,
                    columnSorting: true
                };
                grid_console.text('Loading data...');
                grid.handsontable(grid_options);
                grid_console.text('Data loaded.');

                $('#search_field').on('keyup', function (event) {
                    grid.handsontable('getInstance').search.query(this.value);
                    grid.handsontable('getInstance').render();
                });

                var select_bottle = $("#select_bottle").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    ajax: {
                        url: '/mercuryservices/bottles/',
                        dataType: 'json',
                        data: function (term, page) {
                            return {
                                bottle_unique_name: term
                            };
                        },
                        results: function (data, page) {
                            //data_data = data;
                            //grid.data('handsontable').loadData(data.results);
                            grid_console.text('Filtered data loaded.');
                            return {results: data.results};
                        }
                    },
                    formatResult: formatBottle,
                    formatSelection: formatBottle
                });

                var select_project = $("#select_project").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    data: { results: data_projects, text: 'name'},
                    formatResult: formatName,
                    formatSelection: formatName
                });//.on("change", function(e) {});

                var select_site = $("#select_site").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    ajax: {
                        url: '/mercuryservices/sites/',
                        dataType: 'json',
                        data: function (term, page) {
                            return {
                                name: term
                            };
                        },
                        results: function (data, page) {
                            grid_console.text('Filtered data loaded.');
                            return {results: data.results};
                        }
                    },
                    formatResult: formatName,
                    formatSelection: formatName
                });

                var select_constituent = $("#select_constituent").select2({
                    allowClear: true,
                    multiple: true,
                    //maximumSelectionSize: 1,
                    //dropdownCss:{display:'none'},
                    minimumInputLength: 1,
                    data: { results: data_constituents, text: 'constituent'},
                    formatResult: formatConstituent,
                    formatSelection: formatConstituent
                });

                function formatName(data) {
                    return data.name;
                    /*var newData = [];
                    $.each(data, function(item){
                       newData.push({
                           id: item.id,
                           text: item.name
                       })
                    });
                    return newData;*/
                }

                function formatID(data) {
                    return data.id;
                }

                function formatBottle(data) {
                    return data.bottle_unique_name;
                }

                function formatConstituent(data) {
                    return data.constituent;
                }

                var date_after_sample = $("#date_after_sample").datepicker({
                    dateFormat: "mm/dd/y",
                    maxDate: 0
                });

                var date_before_sample = $("#date_before_sample").datepicker({
                    dateFormat: "mm/dd/y",
                    maxDate: 0
                });

                var date_after_entry = $("#date_after_entry").datepicker({
                    dateFormat: "mm/dd/y",
                    maxDate: 0
                });

                var date_before_entry = $("#date_before_entry").datepicker({
                    dateFormat: "mm/dd/y",
                    maxDate: 0
                });

                grid.parent().find('button[name=search]').click(function () {
                    grid_console.text('Attempting to search...');
                    var thisDataObject = {};
                    thisDataObject['bottle'] = $(select_bottle).val();
                    thisDataObject['project'] = $(select_project).val();
                    thisDataObject['site'] = $(select_site).val();//.slice(0, -1);
                    thisDataObject['date_after_sample'] = $(date_after_sample).val();
                    thisDataObject['date_before_sample'] = $(date_before_sample).val();
                    thisDataObject['date_after_entry'] = $(date_after_entry).val();
                    thisDataObject['date_before_entry'] = $(date_before_entry).val();
                    thisDataObject['constituent'] = $(select_constituent).val();
                    thisDataObject['exclude_null_results'] = $('#excludeNullResults').is(':checked');
                    thisDataObject['page_size'] = "";
                    var dataJSON = JSON.stringify(thisDataObject);
                    $.ajax({
                        url: "{% url 'merlin:results_search' %}",
                        data: dataJSON,
                        dataType: 'json',
                        contentType: "application/json",
                        type: 'POST',
                        success: function (data, textStatus, jqXHRequest) {
                            var content_type = jqXHRequest.getResponseHeader("content-type");
                            // if the content-type is plain text, then it's a custom message from our Django view
                            if (content_type.indexOf('text') > -1) {
                                grid_console.text(data);
                            }
                            // otherwise, it's JSON from the REST Services
                            else if (jqXHRequest.status === 200) {
                                data_data = data;
                                resultPages = Math.ceil(data_data['count'] / 100);
                                grid_console.text(textStatus+': Retrieved '+ data_data['count'] +' results across ' + resultPages + ' pages.' + (resultPages > 1 ? ' Showing first 100 results.' : ''));
                                for (var i = 0; i < data_data['results'].length; i++) {
                                    //grid.data('handsontable').setDataAtCell(i,13,(data_data['results'][i]['method'] === null ? null : data_data['results'][i]['method']['final_value_unit']));
                                    //var row = data_data['results'][i];
                                    //if (row['method'] == null) {row['method'] = {"final_value_unit": ""};}
                                    data_data['results'][i]['method'] === null ? data_data['results'][i]['method'] = {"final_value_unit": ""} : data_data['results'][i]['method'];
                                }
                                grid.data('handsontable').loadData(data_data.results);
                            }
                            else {
                                grid_console.text(textStatus+': Search error: '+jqXHRequest.statusText+', code: '+jqXHRequest.status+'.');
                            }
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + " ... " + textStatus);
                        }
                    });
                });

                grid.parent().find('button[name=next]').click(function () {
                    if (currentPage != resultPages) {
                        $.ajax({
                            url: data_data.next,
                            dataType: 'json',
                            success: function (response) {
                                grid_console.text("success");
                                data_data = response;
                                grid.data('handsontable').loadData(data_data.results);
                                currentPage++;
                                grid_console.text('Page '+ currentPage +' of '+ resultPages +' loaded.');
                            },
                            error: function (response) {
                                grid_console.text("error");
                            }
                        });
                    }
                    else {
                        grid_console.text("End of results, there are no pages after Page " + resultPages + ".");
                    }
                });

                grid.parent().find('button[name=prev]').click(function () {
                    if (currentPage != 1) {
                        $.ajax({
                            url: data_data.previous,
                            dataType: 'json',
                            success: function (response) {
                                grid_console.text("success");
                                data_data = response;
                                grid.data('handsontable').loadData(data_data.results);
                                currentPage--;
                                grid_console.text('Page '+ currentPage +' of '+ resultPages +' loaded.');
                            },
                            error: function (response) {
                                grid_console.text("error");
                            }
                        });
                    }
                    else {
                        grid_console.text("There are no pages before Page 1.");
                    }
                });

                $("input[type=radio][name=valueType]").change(function () {
                    var settings = grid.handsontable('getInstance').getSettings();
                    if (this.value == "report") {
                        settings.columns[12] = {title: 'Result Value', data: 'report_value', readOnly: true, width: 100, format: '0.00000000'};
                        grid.handsontable('getInstance').updateSettings(settings);
                    }
                    else {
                        settings.columns[12] = {title: 'Result Value', data: 'final_value', readOnly: true, width: 100, format: '0.00000000'};
                        grid.handsontable('getInstance').updateSettings(settings);
                    }
                });

                grid.parent().find('button[name=exportCSV]').click(function() {
                    if (exportCSVClicked) {
                        exportCSVClicked = false;
                        $("#exportCSVButtonPanel").hide();
                    }
                    else {
                        exportCSVClicked = true;
                        $("#exportCSVButtonPanel").show();
                    }
                });

                grid.parent().find('button[name=exportCSVCurrentPage]').click(function() {
                    var table = grid.handsontable('getInstance');
                    var csv_filename = "results_" + yearToday + "-" + (monthToday.length == 1 ? "0" + monthToday : monthToday) + "-" + (dayToday.length == 1 ? "0" + dayToday : dayToday) + ".csv";
                    handsontable2csv.download(table, csv_filename);
                    grid.parent().find('button[name=exportCSV]').click();
                });

                grid.parent().find('button[name=exportCSVAllPages]').click(function() {
                    // if there is only one result page, then there is no need to request more data from the server, so just export the current page
                    if (resultPages == 1) {grid.parent().find('button[name=exportCSVCurrentPage]').click(); return false;}
                    // otherwise request all the data matching the search query from the server
                    var thisDataObject = {};
                    thisDataObject['bottle'] = $(select_bottle).val();
                    thisDataObject['project'] = $(select_project).val();
                    thisDataObject['site'] = $(select_site).val();//.slice(0, -1);
                    thisDataObject['date_after_sample'] = $(date_after_sample).val();
                    thisDataObject['date_before_sample'] = $(date_before_sample).val();
                    thisDataObject['date_after_entry'] = $(date_after_entry).val();
                    thisDataObject['date_before_entry'] = $(date_before_entry).val();
                    thisDataObject['constituent'] = $(select_constituent).val();
                    thisDataObject['exclude_null_results'] = $('#excludeNullResults').is(':checked');
                    // page_size is the parameter that will override our self-defined default 100-record pagination
                    // setting it to the nearest hundred above the record count will ensure we get all matching records
                    thisDataObject['page_size'] = (resultPages * 100);
                    var dataJSON = JSON.stringify(thisDataObject);
                    $.ajax({
                        url: "{% url 'merlin:results_search' %}",
                        data: dataJSON,
                        dataType: 'json',
                        contentType: "application/json",
                        type: 'POST',
                        success: function (data, textStatus, jqXHRequest) {
                            if (jqXHRequest.status === 200) {
                                // create a temporary handsontable to package up the data in a CSV file
                                tempgrid = $('#tempgrid');
                                tempgrid.handsontable({startRows: 0, columns: grid_columns});
                                tempdata = data;
                                for (var i = 0; i < tempdata['results'].length; i++) {
                                    tempdata['results'][i]['method'] === null ? tempdata['results'][i]['method'] = {"final_value_unit": ""} : tempdata['results'][i]['method'];
                                }
                                tempgrid.data('handsontable').loadData(tempdata.results);
                                temptable = tempgrid.handsontable('getInstance');
                                csv_filename = "results_" + yearToday + "-" + (monthToday.length == 1 ? "0" + monthToday : monthToday) + "-" + (dayToday.length == 1 ? "0" + dayToday : dayToday) + ".csv";
                                handsontable2csv.download(temptable, csv_filename);
                                delete csv_filename;
                                delete temptable;
                                delete tempdata;
                                delete tempgrid;
                                grid_console.text(textStatus + ': Data exported.');
                            }
                            else {
                                grid_console.text(textStatus+': Export error: '+jqXHRequest.statusText+', code: '+jqXHRequest.status+'.');
                            }
                        },
                        error: function (jqXHRequest, textStatus, errorThrown) {
                            grid_console.text(errorThrown + " ... " + textStatus);
                        }
                    });
                    grid.parent().find('button[name=exportCSV]').click();
                });

            });
        </script>

    </div>

{% endblock %}